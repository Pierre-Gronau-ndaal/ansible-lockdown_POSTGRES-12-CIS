---
# Section 1
# Installation and Patches RHEL
- name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories"
  block:
      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Get repo list RHEL8"
        ansible.builtin.shell: dnf repolist all | grep enabled
        changed_when: false
        failed_when: false
        register: pgs12cis_1_1_enabled_repos_rh8
        when: ansible_distribution_major_version == "8"

      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Get repo list RHEL7"
        ansible.builtin.shell: yum repolist all | grep enabled
        changed_when: false
        failed_when: false
        register: pgs12cis_1_1_enabled_repos_rh7
        when: ansible_distribution_major_version == "7"

      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Show repo list RHEL8"
        ansible.builtin.debug:
            msg:
                - "Warning!! Below are the enabled repo's. Please review to confirm these are authorized repositories. This is a manual task."
                - "{{ pgs12cis_1_1_enabled_repos_rh8.stdout_lines }}"
        when: ansible_distribution_major_version == "8"

      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Show repo list RHEL8"
        ansible.builtin.debug:
            msg:
                - "Warning!! Below are the enabled repo's. Please review to confirm these are authorized repositories. This is a manual task."
                - "{{ pgs12cis_1_1_enabled_repos_rh7.stdout_lines }}"
        when: ansible_distribution_major_version == "7"

      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Present"
        ansible.builtin.import_tasks: warning_facts.yml
  vars:
      warn_control_id: '1.1'
  when:
      - pgs12cis_rule_1_1
      - pgs12cis_section1
      - ansible_distribution_file_variety == 'RedHat'
  tags:
      - level1-postgresql
      - audit
      - rhel
      - rule_1.1

# Section 1
# Installation and Patches Ubuntu
- name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories"
  block:
      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Get repo list Ubuntu"
        ansible.builtin.shell: apt-cache policy
        changed_when: false
        failed_when: false
        register: pgs12cis_1_1_enabled_repos_ub

      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Show repo list Ubuntu | Absent"
        ansible.builtin.debug:
            msg:
                - "Warning!! Below are the enabled repo's. Please review to confirm these are authorized repositories. This is a manual task."
                - "{{ pgs12cis_1_1_enabled_repos_ub.stdout_lines }}"
        when: ansible_distribution == 'Ubuntu'

      - name: "1.1 | AUDIT | Ensure packages are obtained from authorized repositories | Present"
        ansible.builtin.import_tasks: warning_facts.yml
  vars:
      warn_control_id: '1.1'
  when:
      - pgs12cis_rule_1_1
      - pgs12cis_section1
      - ansible_distribution == 'Ubuntu'
  tags:
      - level1-postgresql
      - audit
      - ubuntu
      - rule_1.1
